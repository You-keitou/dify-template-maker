name: Generate PR Summary

on:
  pull_request:
    types: [opened]

jobs:
  generate-summary:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if summary exists
        id: check
        run: |
          if [ -f "./claude-master-book/task-log/pr-${{ github.event.pull_request.number }}.md" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate Summary with Claude
        if: steps.check.outputs.exists == 'false'
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          direct_prompt: |
            /project:summary-pr ${{ github.event.pull_request.number }}
          allowed_tools: |
            Bash(git diff:*),
            Bash(git log:*),
            Bash(git add:*),
            Bash(git commit:*),
            Bash(git push:*),
            Write,
            Read
