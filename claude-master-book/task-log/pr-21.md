---
date: 2025-07-12
pr: 21
branch: feature/analyze-request-tool
tags: [claude-code, dify-template-maker, llm-tools, mastra]
---

# PR #21 - feat: Difyワークフロー要件分析のためのanalyze_requestツールを追加

## 概要
自然言語のリクエストを構造化されたDifyワークフロー要件に変換するツールを実装。既存のweather_toolを置き換え、Difyテンプレート作成の中核機能として、LLMベースの要件分析機能を追加。

## 実装内容
- [[analyze_request_tool]] - 自然言語からDifyワークフロー要件を抽出するLLMベースのツール
- [[prompt_management]] - プロンプトの一元管理システムの構築
- [[structured_output]] - Zodスキーマを使用した構造化出力の実装
- [[industry_patterns]] - 業界別パターンと日本語サポートの追加

## 変更ファイル
- 新規作成:
  - `src/mastra/tools/analyze_request.ts`
  - `src/mastra/prompts/analyze-request.ts`
  - `src/mastra/prompts/index.ts`
  - `src/mastra/prompts/README.md`
  - `.claude-log/4254eec6-1dc8-4dec-a6c1-6ba0a3c9a166.jsonl`
- 修正:
  - `src/mastra/agents/index.ts`
  - `src/mastra/tools/index.ts`
  - `package.json`
  - `pnpm-lock.yaml`
- 削除:
  - `src/mastra/tools/weather_tool.ts`

## Claude Codeセッション詳細
## Claude Code Sessions

### Session: 4254eec6-1dc8-4dec-a6c1-6ba0a3c9a166
Summary: Bash Command Permissions in Claude Code Action / LLM YAML Gen & Agent Memory Research Issues

使用したツール:
ツール使用データなし

主要なリクエスト:
- Caveat: The messages below were generated by the user while running local commands. DO NOT respond t
- <command-name>/mcp</command-name>
- <local-command-stdout>(no content)</local-command-stdout>
- https://github.com/You-keitou/dify-template-maker/issues/12
- output_schemaについてもっと詳しく教えて下さい。

### Session: c666849e-f1f0-4651-86ef-784c9a385a37

使用したツール:
ツール使用データなし

主要なリクエスト:
- ここで、Claude Codeのセッション情報を収集しているが、このコマンドを実行するのに必要な権限を与えたい。なんとなkこのファイルでていぎしたものだけでは足りない気がしている
- Please search the claude-code-action repository for documentation about allowed-tools syntax, partic
- 最高だね。あとは文章を書くということで、textlintを入れてみようと思う。
-  ERR_PNPM_NO_MATCHING_VERSION  No matching version found for @textlint-ja/textlint-rule-preset-ai-wr
- <command-message>summary-claud-code-log is running…</command-message>

### セッションごとの作業内容
- Session: 4254eec6-1dc8-4dec-a6c1-6ba0a3c9a116 - analyze_requestツールの実装とLLMベースの要件分析
  - 使用ツール: コード編集、ファイル操作
  - 主な成果: analyze_request.ts、プロンプト管理システムの作成
- Session: c666849e-f1f0-4651-86ef-784c9a385a37 - Issue #12の実装準備とMCP関連調査
  - 使用ツール: Web検索、ドキュメント参照
  - 主な成果: AWS Core MCPのPROMPT_UNDERSTANDINGパターンの調査

## Claude Code活用のポイント
### 効果的だった使い方
- LLMベースのツール実装において、AWS Core MCPの実装パターンを参考にした設計
- プロンプトの一元管理により、今後のプロンプト改善が容易に

### 学んだTips
- Mastraでの構造化出力（structured output）はZodスキーマとLLMの組み合わせで実現
- Geminiモデルを使用することで、日本語での要件分析が高精度で可能

## 技術的な決定事項
- **LLMモデルの選択**: OpenAIではなくGeminiを採用（メインエージェントとの一貫性）
- **プロンプト管理**: 個別ファイルでのプロンプト管理により、バージョン管理とメンテナンスを容易に
- **パターンマッチング vs LLM**: 純粋なLLMアプローチを採用（柔軟性と精度を重視）
- **業界別コンテキスト**: 医療、金融、教育など6業界のパターンを事前定義

## 関連リンク
- [[PR #18]] - textlint統合の追加
- [[Issue #12]] - analyze_requestツールの実装要件
## textlint チェック結果

<details>
<summary>AI生成テキストの改善提案</summary>

```

/Users/keith/WorkSpace/dify-template-maker/claude-master-book/task-log/pr-21.md
  38:959  error  Line 38 sentence length(101) exceeds the maximum sentence length of 100.
Over 1 characters  ja-technical-writing/sentence-length
  41:10   error  文末が"。"で終わっていません。                                            ja-technical-writing/ja-no-mixed-period
  43:9    error  文末が"。"で終わっていません。                                            ja-technical-writing/ja-no-mixed-period
  53:10   error  文末が"。"で終わっていません。                                            ja-technical-writing/ja-no-mixed-period
  55:9    error  文末が"。"で終わっていません。                                            ja-technical-writing/ja-no-mixed-period
  56:63   error  不自然なアルファベットがあります: k                                       ja-technical-writing/ja-unnatural-alphabet
  58:39   error  弱い表現: "思う" が使われています。                                       ja-technical-writing/ja-no-weak-phrase

✖ 7 problems (7 errors, 0 warnings)

```
</details>
